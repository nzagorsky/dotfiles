#!/usr/bin/env bash
set -ex

# Fail fast if required CLIs aren't installed
missing=()
for cmd in bw jq rclone; do
    command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
done
if ((${#missing[@]})); then
    echo "ERROR: missing required commands: ${missing[*]}" >&2
    exit 1
fi

# Add rclone b2 config
rclone config delete b2
rclone config create b2 b2
rclone ls b2: --max-depth 2 >/dev/null 2>&1 || echo "NOTE: Failed to setup configuration"

# Setup rest of the credentials
rclone sync b2:$B2_BUCKET_NAME/secure/.config/gnupg ~/.config/gnupg --create-empty-src-dirs
rclone sync b2:$B2_BUCKET_NAME/secure/.config/kube ~/.config/kube --create-empty-src-dirs
rclone sync b2:$B2_BUCKET_NAME/secure/.ssh ~/.ssh --create-empty-src-dirs

chmod -R 700 ~/.config/gnupg
chmod -R 700 ~/.config/kube
chmod -R 700 ~/.ssh
