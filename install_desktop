#!/usr/bin/env bash
# vim:foldmethod=marker:foldlevel=0

# TODO make output of script less verbose
# TODO create backup solution with rclone
# TODO install lutris (possibly create install_gaming script)
# TODO fix extensions that are not installing on first run

# Utils {{{

identify_os () {
    . /etc/os-release
    echo $NAME | tr '[:upper:]' '[:lower:]'
}

setup_yay () {
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si
}

arch_docker() {
    sudo pacman -S --needed --noconfirm docker
    sudo systemctl enable docker --now
    sudo gpasswd -a $USER docker
}

setup_services() {
    sudo systemctl enable bluetooth --now
    sudo systemctl enable dnsmasq --now
}

setup_user() {
    sudo gpasswd -a $USER rfkill
}

# NOTE: not used
virtd() {
    sudo pacman -S libvirt qemu ebtables virt-manager --needed --noconfirm
    sudo gpasswd -a $USER kvm
    sudo gpasswd -a $USER libvirt
    sudo systemctl enable libvirtd --now
}

# }}}

# Arch {{{
install_yay_packages() {
    yay -S --needed --noconfirm  \
        authy \
        dbeaver \
        fondo \
        gnome-shell-extension-installer \
        google-chrome \
        mailspring \
        rancher-k3d-bin \
        toptracker \
	&& echo -e '\033[1mYAY packages are installed\033[0m'
}

install_base_desktop_manjaro() {
    sudo pacman -S --needed --noconfirm \
        alacritty \
        bluez-tools \
        bluez-utils \
        chrome-gnome-shell \
        openvpn \
        pavucontrol \
        pulsemixer \
        rclone \
        telegram-desktop \
        transmission-gtk \
        xclip \
        yay \
    && arch_docker \
	&& echo -e '\033[1mBase desktop packages are installed\033[0m'


}

install_base_desktop_arch () {
    # Check if yay is present and install it if not.
    command -v yay || setup_yay

    sudo pacman -S --needed --noconfirm telegram-desktop
    sudo pacman -S --needed --noconfirm openvpn
    sudo pacman -S --needed --noconfirm rclone  # backups
    sudo pacman -S --needed --noconfirm playerctl  # Control player from keyboard
    sudo pacman -S --needed --noconfirm kitty  # GPU term
    sudo pacman -S --needed --noconfirm alacritty  # GPU term
    sudo pacman -S --needed --noconfirm xclip  # neovim shared copy/paste buffer
    sudo pacman -S --needed --noconfirm dnsmasq

    docker

    # BT Sound and A2DP
    sudo pacman -S --needed --noconfirm pulseaudio-bluetooth
    sudo pacman -S --needed --noconfirm pavucontrol
    sudo pacman -S --needed --noconfirm pulsemixer
    sudo pacman -S --needed --noconfirm bluez-tools bluez-utils

    # Fonts
    # https://wiki.archlinux.org/index.php/Fonts
    sudo pacman -S --needed --noconfirm gnu-free-fonts
    sudo pacman -S --needed --noconfirm noto-fonts
    sudo pacman -S --needed --noconfirm noto-fonts-emoji
    sudo pacman -S --needed --noconfirm noto-fonts-extra
    sudo pacman -S --needed --noconfirm ttf-hack  # Terminal
    sudo pacman -S --needed --noconfirm ttf-liberation  # Mono fonts in browsers
    sudo pacman -S --needed --noconfirm ttf-roboto
    sudo pacman -S --needed --noconfirm ttf-roboto-mono
    yay -S --needed --noconfirm consolas-font

}
# }}}

# Debian {{{
install_desktop_debian () {
    sudo apt-get update
    sudo apt-get install -y openvpn
    sudo apt-get install -y docker.io
    sudo apt-get install -y xclip
    sudo apt-get install -y kitty
}
# }}}

# Gnome config {{{

install_gnome_extension() {
    extension_name=$1
    extension_id=$2

    gnome-extensions list | grep $extension_name > /dev/null  || \
        gnome-shell-extension-installer --yes $extension_id
    gnome-extensions enable $extension_name
}

configure_gnome () {
    # Put dconf settings in
    dconf load  / < optional/dconf.conf
    gsettings set org.gnome.shell.app-switcher current-workspace-only true
    gsettings set org.gnome.desktop.peripherals.keyboard repeat-interval 20
    gsettings set org.gnome.desktop.peripherals.keyboard delay 200

    # Disable all extensions firts
    for EXT in $(gnome-extensions list)
    do
        gnome-extensions disable $EXT
    done

    # Install and enable required extensions

    gnome-shell-extension-installer --update
    install_gnome_extension gsconnect@andyholmes.github.io 1319  # GSconnect
    install_gnome_extension disable-workspace-switcher-popup@github.com 959   # Workspace switch popup disabler
    install_gnome_extension audio-switcher@AndresCidoncha 1092  # Audio input/output switch from top bar
    install_gnome_extension appindicatorsupport@rgcjonas.gmail.com 615  # KStatusNotifierItem

    # install_gnome_extension disableworkspaceanim@owilliams.mixxx.org 1328  # Workspace switch animation disabler
    # install_gnome_extension auto-move-windows@gnome-shell-extensions.gcampax.github.com 16  # AutoMoveWindows
    # install_gnome_extension unite@hardpixel.eu 1287  # Unite
    # install_gnome_extension caffeine@patapon.info 517  # caffeine
    # install_gnome_extension dash-to-panel@jderose9.github.com 1160  # Dash to panel
    # install_gnome_extension blyr@yozoon.dev.gmail.com 1251  # blyr
    # install_gnome_extension dash-to-dock@micxgx.gmail.com 307  # dash to dock
    # install_gnome_extension hidetopbar@mathieu.bidon.ca 545  # hide top bar
}
# }}}

main () {
    OS_DETECTED=`identify_os`
    echo -e "\033[1m"
    echo "------------------------------"
    echo "OS: $OS_DETECTED"
    echo "Desktop: $XDG_SESSION_DESKTOP"
    echo "------------------------------"
    echo -e "\033[0m"

    if [ "$OS_DETECTED" == "arch linux" ]; then
        setup_user
        install_base_desktop_arch
        install_yay_packages

    elif [ "$OS_DETECTED" == "manjaro linux" ]; then
        install_base_desktop_manjaro
        install_yay_packages

    elif [ "$OS_DETECTED" == "ubuntu" ]; then
        install_base_desktop_debian

    else
        echo "Did not detect OS. Quitting."
        exit 1
    fi
    # ------------------------------------------

    if [ "$XDG_SESSION_DESKTOP" == "gnome" ]; then
        configure_gnome

    else
        echo "Did not detect session. Check XDG_SESSION_DESKTOP variable. Current value is $XDG_SESSION_DESKTOP"
        exit 1
    fi

}

main
